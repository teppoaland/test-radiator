<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      themeVariables: {
        fontFamily: 'Arial',
        fontSize: '13px',
        primaryColor: '#f9f',
        primaryTextColor: '#000000',
        primaryBorderColor: '#333',
        lineColor: '#333',
        secondaryColor: '#eef',
        secondaryTextColor: '#000000',
        tertiaryColor: '#dfd',
        tertiaryTextColor: '#000000',
        quaternaryColor: '#ffe',
        quaternaryTextColor: '#000000'
      }
    });
  </script>
  <style>
    body {
      background-color: white;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
  </style>
</head>
<body>
  <div class="mermaid">
flowchart TD
    subgraph Azure [Azure DevOps]
        ADO[Azure DevOps Project]
        ADP[Azure Pipeline]
        ADA[Self-hosted Agent]
        WI[Work Items]
        PAT[PAT Authentication]
        BUGS[Auto-Generated Bugs]
    end

    subgraph GitHub [GitHub Cloud]
        GHR[sbsaa Repository]
        GHA[GitHub Actions]
        GHP[GitHub Pages]
    end

    subgraph Storage [Git Storage]
        GSR[git_storage repo]
        APT[appium-tests/]
        SBT[sbsaa-tests/]
        RD[radiator-data/]
        MAP[test-mappings/]
    end

    subgraph Runner [Self-Hosted Runner WIN10]
        SH[Actions Runner]
        AS[Appium Server]
        PY[Python + pytest]
        UH[History Manager]
        AO[Allure Generator]
        ADB[ADB Bridge]
        TR[Test Radiator]
        AZ[Azure DevOps Client]
        HOOKS[Pytest Hooks]
    end

    subgraph Device [Android Device]
        AOS[Android OS]
        SA[Weather App]
        ADBD[ADB Daemon]
    end

    subgraph Radiator [Test Radiator Dashboard]
        RDB[Radiator Database]
        RUI[Dashboard UI]
        RAPI[Status API]
        FC[Flowchart View]
    end

    %% Main execution flow - vertical layout
    ADP -->|"Manual trigger"| GHR
    GHR -->|"Push [test] commit"| GHA
    GHA -->|"Start workflow"| SH
    SH -->|"Load history"| GSR
    SH -->|"Load mappings"| MAP
    SH -->|"Execute tests"| AS
    AS -->|"Control device"| ADB
    ADB -->|"Connect to"| ADBD
    ADBD -->|"Test app"| SA
    
    %% Pytest hooks and Azure integration
    HOOKS -->|"Capture results"| AZ
    AZ -->|"Authenticate"| PAT
    PAT -->|"Connect to"| ADO
    AZ -->|"Update work items"| WI
    AZ -->|"Create bugs on fail"| BUGS
    
    %% Report generation and storage
    PY -->|"Process results"| UH
    UH -->|"Generate reports"| AO
    AO -->|"Deploy to"| GHP
    AO -->|"Save history"| GSR
    AZ -->|"Update mappings"| MAP
    
    %% Radiator integration
    TR -->|"Real-time status"| RDB
    TR -->|"Store data"| RD
    RDB -->|"Update dashboard"| RUI
    RUI -->|"Display on"| GHP
    RAPI -->|"Serve status"| RUI
    FC -->|"Architecture view"| RUI

    %% Agent hosting
    ADA -->|"Hosts"| ADP

    style Azure fill:#0078d4,color:#fff
    style GitHub fill:#4a9eff,color:#fff
    style Storage fill:#d69e2e,color:#fff
    style Runner fill:#38a169,color:#fff
    style Device fill:#2d3748,color:#fff
    style Radiator fill:#805ad5,color:#fff
  </div>

  <h3>Hybrid CI/CD Architecture Features:</h3>
  <ul>
    <li><strong>Dual Trigger System:</strong> Manual execution via Azure DevOps or automatic via GitHub commits with [test]</li>
    <li><strong>Azure Integration:</strong> Test Cases automatically updated with execution results and status transitions</li>
    <li><strong>Git Storage Database:</strong> Centralized history persistence across multiple projects</li>
    <li><strong>Project Isolation:</strong> Separate namespaces (appium-tests, sbsaa-tests) prevent data contamination</li>
    <li><strong>Version Tracking:</strong> App version information stored and tracked across test runs</li>
    <li><strong>Cross-Platform Agents:</strong> Azure self-hosted agent triggers GitHub Actions runner</li>
    <li><strong>Real Device Testing:</strong> Hardware-accelerated execution with ADB shell support</li>
    <li><strong>Comprehensive Reporting:</strong> Allure reports with Azure DevOps traceability</li>
  </ul>

  <h3>Execution Flow Options:</h3>
  
  <h4>Option 1: Azure DevOps Trigger</h4>
  <ol>
    <li>Manually run Azure DevOps pipeline</li>
    <li>Pipeline pushes empty commit with [test] to GitHub repository</li>
    <li>GitHub Actions detects [test] keyword and triggers workflow</li>
    <li>Continue with standard test execution flow</li>
  </ol>

  <h4>Option 2: GitHub Direct Trigger</h4>
  <ol>
    <li>Push code with [test] in commit message to GitHub</li>
    <li>GitHub Actions immediately triggers workflow</li>
    <li>Continue with standard test execution flow</li>
  </ol>

  <h4>Standard Test Execution Flow:</h4>
  <ol>
    <li>Load previous test history from git storage</li>
    <li>Prepare history files for current test run</li>
    <li>Execute pytest test suite against real Android device</li>
    <li>Update Azure DevOps Test Cases with pass/fail results</li>
    <li>Generate Allure HTML report with historical trends</li>
    <li>Clean up malformed data that Allure injects</li>
    <li>Save updated history and version info to git storage</li>
    <li>Deploy final report to GitHub Pages</li>
  </ol>

  <h3>Azure DevOps Integration:</h3>
  <ul>
    <li><strong>Test Case Management:</strong> Work items automatically updated with test results</li>
    <li><strong>Traceability:</strong> Direct links between test functions and Azure work items</li>
    <li><strong>Status Transitions:</strong> Test Cases move from Design â†’ Closed on pass, stay Ready on fail</li>
    <li><strong>Execution History:</strong> Detailed logs stored in Azure DevOps work item history</li>
    <li><strong>Manual Triggering:</strong> On-demand test execution from Azure DevOps UI</li>
  </ul>
</body>
</html>